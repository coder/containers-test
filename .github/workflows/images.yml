# Container image build workflow
# This file is automatically generated, see images.yml.sh
name: images

on:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main

  schedule:
    # Re-build all images at 2am UTC every Monday (8pm CST/9pm CDT)
    #
    # This ensures we always start with a recent base image, which
    # reduces wasted space due to written-over files in the writable
    # layer, ensures packages are up-to-date (since many of these
    # images install the latest versions of packages available at
    # build time), and allow us to ensure that images continue to
    # be buildable from source (no removed packages).
    #
    # See: https://crontab.guru/#0_2_*_*_1
    - cron: "0 2 * * 1"

  workflow_dispatch:

permissions:
  actions: write # for cancel-workflow-action
  checks: none
  contents: read
  deployments: none
  id-token: write # for workload identity federation
  issues: none
  packages: none
  pull-requests: none
  repository-projects: none
  security-events: none
  statuses: none

# Cancel in-progress runs for pull requests when developers push
# additional changes
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}
jobs:
  ubuntu-minimal-focal:
    name: ubuntu/minimal/focal
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-ubuntu-minimal:focal
        run: |
          ./scripts/build_image.sh \
            --name=coder-ubuntu-minimal \
            --path="${{ github.workspace }}/images/ubuntu/minimal/focal" \
            --tag="focal" \
            --tag="latest" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  ubuntu-base-focal:
    name: ubuntu/base/focal
    needs:
      - ubuntu-minimal-focal
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-ubuntu-base:focal
        run: |
          ./scripts/build_image.sh \
            --name=coder-ubuntu-base \
            --path="${{ github.workspace }}/images/ubuntu/base/focal" \
            --tag="focal" \
            --tag="latest" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  ubuntu-minimal-jammy:
    name: ubuntu/minimal/jammy
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-ubuntu-minimal:jammy
        run: |
          ./scripts/build_image.sh \
            --name=coder-ubuntu-minimal \
            --path="${{ github.workspace }}/images/ubuntu/minimal/jammy" \
            --tag="jammy" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  ubuntu-base-jammy:
    name: ubuntu/base/jammy
    needs:
      - ubuntu-minimal-jammy
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-ubuntu-base:jammy
        run: |
          ./scripts/build_image.sh \
            --name=coder-ubuntu-base \
            --path="${{ github.workspace }}/images/ubuntu/base/jammy" \
            --tag="jammy" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  ubuntu-minimal-rolling:
    name: ubuntu/minimal/rolling
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-ubuntu-minimal:rolling
        run: |
          ./scripts/build_image.sh \
            --name=coder-ubuntu-minimal \
            --path="${{ github.workspace }}/images/ubuntu/minimal/rolling" \
            --tag="rolling" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  ubuntu-base-rolling:
    name: ubuntu/base/rolling
    needs:
      - ubuntu-minimal-rolling
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-ubuntu-base:rolling
        run: |
          ./scripts/build_image.sh \
            --name=coder-ubuntu-base \
            --path="${{ github.workspace }}/images/ubuntu/base/rolling" \
            --tag="rolling" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  debian-minimal-bullseye:
    name: debian/minimal/bullseye
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-debian-minimal:bullseye
        run: |
          ./scripts/build_image.sh \
            --name=coder-debian-minimal \
            --path="${{ github.workspace }}/images/debian/minimal/bullseye" \
            --tag="bullseye" \
            --tag="latest" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  debian-base-bullseye:
    name: debian/base/bullseye
    needs:
      - debian-minimal-bullseye
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-debian-base:bullseye
        run: |
          ./scripts/build_image.sh \
            --name=coder-debian-base \
            --path="${{ github.workspace }}/images/debian/base/bullseye" \
            --tag="bullseye" \
            --tag="latest" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  debian-minimal-testing:
    name: debian/minimal/testing
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-debian-minimal:testing
        run: |
          ./scripts/build_image.sh \
            --name=coder-debian-minimal \
            --path="${{ github.workspace }}/images/debian/minimal/testing" \
            --tag="testing" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  debian-base-testing:
    name: debian/base/testing
    needs:
      - debian-minimal-testing
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-debian-base:testing
        run: |
          ./scripts/build_image.sh \
            --name=coder-debian-base \
            --path="${{ github.workspace }}/images/debian/base/testing" \
            --tag="testing" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  debian-minimal-unstable:
    name: debian/minimal/unstable
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-debian-minimal:unstable
        run: |
          ./scripts/build_image.sh \
            --name=coder-debian-minimal \
            --path="${{ github.workspace }}/images/debian/minimal/unstable" \
            --tag="unstable" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  debian-base-unstable:
    name: debian/base/unstable
    needs:
      - debian-minimal-unstable
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-debian-base:unstable
        run: |
          ./scripts/build_image.sh \
            --name=coder-debian-base \
            --path="${{ github.workspace }}/images/debian/base/unstable" \
            --tag="unstable" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  ubi-minimal-8:
    name: ubi/minimal/8
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-ubi-minimal:8
        run: |
          ./scripts/build_image.sh \
            --name=coder-ubi-minimal \
            --path="${{ github.workspace }}/images/ubi/minimal/8" \
            --tag="8" \
            --tag="latest" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  ubi-base-8:
    name: ubi/base/8
    needs:
      - ubi-minimal-8
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-ubi-base:8
        run: |
          ./scripts/build_image.sh \
            --name=coder-ubi-base \
            --path="${{ github.workspace }}/images/ubi/base/8" \
            --tag="8" \
            --tag="latest" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  centos-minimal-stream8:
    name: centos/minimal/stream8
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-centos-minimal:stream8
        run: |
          ./scripts/build_image.sh \
            --name=coder-centos-minimal \
            --path="${{ github.workspace }}/images/centos/minimal/stream8" \
            --tag="stream8" \
            --tag="latest" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  centos-base-stream8:
    name: centos/base/stream8
    needs:
      - centos-minimal-stream8
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-centos-base:stream8
        run: |
          ./scripts/build_image.sh \
            --name=coder-centos-base \
            --path="${{ github.workspace }}/images/centos/base/stream8" \
            --tag="stream8" \
            --tag="latest" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  centos-minimal-stream9:
    name: centos/minimal/stream9
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-centos-minimal:stream9
        run: |
          ./scripts/build_image.sh \
            --name=coder-centos-minimal \
            --path="${{ github.workspace }}/images/centos/minimal/stream9" \
            --tag="stream9" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  centos-base-stream9:
    name: centos/base/stream9
    needs:
      - centos-minimal-stream9
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-centos-base:stream9
        run: |
          ./scripts/build_image.sh \
            --name=coder-centos-base \
            --path="${{ github.workspace }}/images/centos/base/stream9" \
            --tag="stream9" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  fedora-minimal-35:
    name: fedora/minimal/35
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-fedora-minimal:35
        run: |
          ./scripts/build_image.sh \
            --name=coder-fedora-minimal \
            --path="${{ github.workspace }}/images/fedora/minimal/35" \
            --tag="35" \
            --tag="latest" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  fedora-base-35:
    name: fedora/base/35
    needs:
      - fedora-minimal-35
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-fedora-base:35
        run: |
          ./scripts/build_image.sh \
            --name=coder-fedora-base \
            --path="${{ github.workspace }}/images/fedora/base/35" \
            --tag="35" \
            --tag="latest" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  fedora-minimal-rawhide:
    name: fedora/minimal/rawhide
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-fedora-minimal:rawhide
        run: |
          ./scripts/build_image.sh \
            --name=coder-fedora-minimal \
            --path="${{ github.workspace }}/images/fedora/minimal/rawhide" \
            --tag="rawhide" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  fedora-base-rawhide:
    name: fedora/base/rawhide
    needs:
      - fedora-minimal-rawhide
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-fedora-base:rawhide
        run: |
          ./scripts/build_image.sh \
            --name=coder-fedora-base \
            --path="${{ github.workspace }}/images/fedora/base/rawhide" \
            --tag="rawhide" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  arch-minimal-base:
    name: arch/minimal/base
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-arch-minimal:base
        run: |
          ./scripts/build_image.sh \
            --name=coder-arch-minimal \
            --path="${{ github.workspace }}/images/arch/minimal/base" \
            --tag="base" \
            --tag="latest" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  arch-base-base:
    name: arch/base/base
    needs:
      - arch-minimal-base
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-arch-base:base
        run: |
          ./scripts/build_image.sh \
            --name=coder-arch-base \
            --path="${{ github.workspace }}/images/arch/base/base" \
            --tag="base" \
            --tag="latest" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  arch-minimal-base-devel:
    name: arch/minimal/base-devel
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-arch-minimal:base-devel
        run: |
          ./scripts/build_image.sh \
            --name=coder-arch-minimal \
            --path="${{ github.workspace }}/images/arch/minimal/base-devel" \
            --tag="base-devel" \
            --pull-request="${{ github.event.number }}" \
            --push=true

  arch-base-base-devel:
    name: arch/base/base-devel
    needs:
      - arch-minimal-base-devel
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          # unlimited fetch depth is required for files_changed
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: projects/477254869654/locations/global/workloadIdentityPools/github/providers/github
          service_account: github@coder-ci.iam.gserviceaccount.com

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v0

      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker us-docker.pkg.dev

      - name: Configure Docker for Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build coder-arch-base:base-devel
        run: |
          ./scripts/build_image.sh \
            --name=coder-arch-base \
            --path="${{ github.workspace }}/images/arch/base/base-devel" \
            --tag="base-devel" \
            --pull-request="${{ github.event.number }}" \
            --push=true

